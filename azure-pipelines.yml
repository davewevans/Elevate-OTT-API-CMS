trigger:
  branches:
    include:
      - develop  # Adjust this based on the branch you want to sync

pool:
  vmImage: 'windows-latest'

steps:
  - checkout: self
    persistCredentials: true
    clean: false
    fetchDepth: 0  # Ensures full clone instead of shallow clone

  - script: |
      echo "ðŸ”¹ Starting Git Configuration"
      git config --global user.email "davewevans72@gmail.com"
      git config --global user.name "davewevans"

      echo "ðŸ”¹ Setting remote origin to Azure DevOps"
      git remote set-url origin "https://elevateott@dev.azure.com/elevateott/Elevate-OTT-API-CMS/_git/Elevate-OTT-API-CMS"

      echo "ðŸ”¹ Configuring GitHub remote"
      git remote remove github 2>nul || echo "No remote to remove"
      git remote add github "https://$(GITHUB_PAT)@github.com/davewevans/Elevate-OTT-API-CMS.git"

      echo "ðŸ”¹ Checking remotes:"
      git remote -v      

      echo "ðŸ”¹ Fetching latest changes from Azure DevOps"
      git fetch origin develop --prune
      
      echo "ðŸ”¹ Checking out develop branch"
      git checkout develop || git checkout -b develop origin/develop

      echo "ðŸ”¹ Ensuring complete Git history is available"
      git pull --unshallow

      echo "ðŸ”¹ Pulling latest changes"
      git pull --rebase origin develop

      echo "ðŸ”¹ Running Git Garbage Collection"
      git gc --prune=now

      echo "ðŸ”¹ Pushing updates to GitHub"
      git push github develop --force --verbose
    displayName: 'Mirror develop branch to GitHub'
